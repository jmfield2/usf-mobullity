<!DOCTYPE html>
<!--[if lt IE 7 ]> <html dir="ltr" lang="en-US" class="ie6"> <![endif]-->
<!--[if IE 7 ]>    <html dir="ltr" lang="en-US" class="ie7"> <![endif]-->
<!--[if IE 8 ]>    <html dir="ltr" lang="en-US" class="ie8"> <![endif]-->
<!--[if IE 9 ]>    <html dir="ltr" lang="en-US" class="ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html dir="ltr" lang="en-US"> <!--<![endif]-->

<head>
<title>USF Bike Share Rebalancing</title>

<!--  Mobile Viewport Fix -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<!-- Google WebFonts -->
<link href='http://fonts.googleapis.com/css?family=Dancing+Script:700' rel='stylesheet' type='text/css'>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

<!-- jquery -->
<script src="static/js/lib/jquery/jquery-1.9.1.js"></script>

<!-- jquery-ui -->
<script src="static/js/lib/jquery-ui/js/jquery-ui-1.9.1.custom.min.js"></script>
<link rel="stylesheet" href="static/js/lib/jquery-ui/css/smoothness/jquery-ui-1.9.1.custom.css" />
<script src="static/js/lib/jquery-ui/addons/jquery-ui-timepicker.js"></script>
<link rel="stylesheet" href="static/js/lib/jquery-ui/addons/jquery-ui-timepicker.css" />

<!-- leaflet -->
<script src="static/js/lib/leaflet/leaflet.js"></script>
<link rel="stylesheet" href="static/js/lib/leaflet/leaflet.css" />
<!--[if lte IE 8]>
    <link rel="stylesheet" href="static/js/lib/leaflet/leaflet.ie.css" />
<![endif]-->

<!-- Mustache/ICanHaz -->
<script src="static/js/lib/ICanHaz.min.js"></script>

<link rel="stylesheet" href="static/style.css?v=1" />

<!-- make legacy Internet Explorer play nice(r) -->
<!--[if lt IE 9]>
  <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <script src="js/lib/respond.min.js"></script>
<![endif]-->

<script src="static/js/Geo.js?v=1"></script>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>

</head>
<body>

<header id="branding" role="banner" class="clearfix">

	<h2>USF Bikeshare Rebalancing</h2>

</header><!-- #branding -->

<!-- layout has one row, and two columns -->
<div class="container">
<div class="row">

<div class="table-cell col-sm-4" id="instructions">

<div id="form" class="step_1">
<form action="javascript:void(0)" name='form' method=POST enctype="multipart/form-data">

<table border=0 cellspacing=0 cellpadding=0>
<colgroup>
    <col width=60% />
    <col width=40% />
</colgroup>
<tr>
<td align=left>Rebalancing Operation:</td>
<td><select name="rebalance_type" onchange="rebal_change(this)">
<option value="1" selected>Rebalancing</option>
<option value="2">Changing Batteries</option>
<option value="3">Bring Back Unusable Bikes</option>
<option value="4">Rebalance + Bring Back Unusable Bikes</option>
</select></td>
</tr>

<tr>
<td align=left>Time limit:<br>(in seconds, 0 for no limit)</td>
<td><input type=text name="time_limit" value="0" /></td>
</tr>

<tr>
<td valign=top align=left>Capacity of the Vehicles:<br>Capacity,Map#</td>
<td><textarea rows=1 name="vehicle_capacity">10,1</textarea></td>
</tr>

<tr>
<td align=left>Location of the Depot: (default REC)</td>
<td><input type=text name="depot_location" id="depot_location" /></td>
</tr>


<tr class="rebal_op rebal_op_1 rebal_op_4">
<td align=left>Measure Imbalance:<br>(For rebalancing)</td>
<td><select name="measure_imbalance" onchange="rebal_imbalance(this)">
<option value="1">User Input</option>
<option value="2" selected>Automatic</option>
</select>
<br/>
<input type=file class="rebal_imbalance" name="imbalance_input" style="display:none"/>
</td>
</tr>

<tr class="rebal_op rebal_op_1 rebal_op_4">
<td align=left>Empty Rack Locations:</td>
<td><input type=file name="empty_racks" /></td>
</tr>

<tr class="rebal_op rebal_op_1 rebal_op_4">
<td align=left>Usable Bike Locations:</td>
<td><input type=file name="usable_bikes" /></td>
</tr>

<tr class="rebal_op rebal_op_2" style="display:none">
<td align=left>Bike Locations needing replacement batteries:</td>
<td><input type=file name="location_battery_replacements" /></td>
</tr>

<tr class="rebal_op rebal_op_3 rebal_op_4" style="display:none">
<td align=left>Unusable Bike Locations:</td>
<td><input type=file name="unusable_bikes" /></td>
</tr>

</table>

<br>
<input id="rebal_submit" class="btn btn-success" type=submit value="Submit" />

</form>

</div> <!-- .step_1 -->
<br>

<div id="tour_container">

    <div class="show_form" style="display:none;text-align:center">
        <a href="javascript:void(0)" onclick="show_form()">Show Form</a>
    </div>

<div id="notes">

    <div class="step_2" style="text-align:center">
    The rebalancing instructions will appear here.
    <br>
    <img width=50 class="spinner" src="/static/loading.gif" style="display:none;" />
    </div>

    <div class="step_3" style="display:none">

    </div>

</div>

<div class="tour_buttons" align=center style="display:none">

<br><br>
<input class="btn btn-success" type=button onclick="_route('next')" value="Next Step" />
<input class="btn btn-success" type=button onclick="_route('depot')" value="Return to Depot" />

</div>

</div>


</div>
<div class="table-cell col-sm-8" id="map">&nbsp;</div>

</div> <!-- /row -->
</div> <!-- /container -->



<script id="note_templ" type="text/html">
{% raw %}
<div id="leg_{{id}}" class="leg" data-id="{{id}}" data-loc="{{Latitude}},{{Longitude}}">
{{ID}}
{{row}}
Step {{id}}: Station ({{Latitude}}, {{Longitude}})<br>
{{#Pickups}}
Pickups: {{Pickups}} Dropoffs: {{Dropoffs}}
{{/Pickups}}
{{#Number of Bikes}}
Number of Bikes: {{Number of Bikes}}
{{/Number of Bikes}}
</div>
<div class="leg_directions" id="leg_{{id}}">
<li>Turn-by-Turn Directions</li>
{{ turns }}
</div>
{% endraw %}
</script>


<script>
var config = {};
// Use for routing
config['otp_url'] = "mobullity.forest.usf.edu/otp/routers/default/plan";

config['rebalance_uri'] = "/rebalance/process";
config['notes_div'] = ".step_3"; // The target for rebalancing results
config['depot'] = L.latLng(28.059885956844763,-82.40777134895325);

// Map icons
var SmallIcon = L.icon({
        iconUrl: '/static/images/marker-sm-50pct.png',
        shadowUrl: null,
        iconSize: new L.point(15, 10),
        iconAnchor: new L.point(5, 8),
        popupAnchor: new L.point(0, -8)
});

var StartFlagIcon = L.icon({
        iconUrl: '/static/marker-flag-start-shadowed.png',
        shadowUrl: null,
        iconSize: new L.Point(48, 49),
        iconAnchor: new L.Point(46, 42),
        popupAnchor: new L.Point(0, -16)
});

var EndFlagIcon = L.icon({
        iconUrl: '/static/marker-flag-end-shadowed.png',
        shadowUrl: null,
        iconSize: new L.Point(48, 49),
        iconAnchor: new L.Point(46, 42),
        popupAnchor: new L.Point(0, -16)
});

var StartIcon = StartFlagIcon;
var EndIcon = EndFlagIcon;

// Map layers for markers, and route polylines
var layer = L.layerGroup();
var directions = L.layerGroup();
var layer_hubs = L.layerGroup();
// XXX need markers layer

var last_station = null;

hubs = {};
// Default Depot is @ Campus Rec
default_depot = config['depot'];

colors = {'car': 'red', 'walk':'blue', 'bike':'green'};

// Toggle client location tracking for DEPOT and CURRENT POSITION
var location_tracking = {};


function show_form() {
        $('.show_form').hide();
        $('#form').show();
        $('.step_2').show();
        $('.tour_buttons').hide();
        $('.step_3').hide();
        layer.clearLayers();
        directions.clearLayers();
        layer_hubs.addTo( lmap );
}

function rebal_change(obj) {

    id = $(obj).val();

    $('.rebal_op').hide()

    $('.rebal_op_' + id).show();
}

function rebal_imbalance(obj) {
    id = $(obj).val();

    if (id != 1)  $('.rebal_imbalance').hide();
    else $('.rebal_imbalance').show();
}


function toggle_location_mouse_tracking(params) {
	btn = params['button'];

	on = $(btn).data('on');
	if (on == "on") {
		$(btn).data('on', "off");
		location_tracking = {};

        lmap.off('click');
        lmap.off('mousemove');
	}
	else {
		$(btn).data('on', "on");
		location_tracking = params;

		lmap.on('click', map_handle_click);
		lmap.on('mousemove', map_update_location);
	}
}

function handle_location_gps_tracking(params) {
	// XXX

}

// Allow user to click on the map
function map_handle_click(e) {
	add_location_marker(e.latlng, location_tracking['input_elem']);

	$(location_tracking['button']).click();
}

function map_update_location(e) {
	$(location_tracking[params['input_elem']]).val("("+e.latlng.lat+","+e.latlng.lng+")");
}

// Create a leaflet market @ position and add to map on marker layer
function add_location_marker(pos, input_elem) {
	layer.clearLayers();
	layer.addLayer( L.marker(pos, {}) );
	layer.addTo(lmap);

	if (input_elem != undefined)
	        $(input_elem).val("("+pos.lat+","+pos.lng+")");
}

function _use_depot(id) {

    default_depot = hubs[id]['pos'];

    // Redraw markers
    for (x in hubs) {
        add_hub_marker(hubs[x]);
    }
}

function add_hub_marker(x) {
    opts = {};
    m = L.marker(L.latLng(parseFloat(x['lat']), parseFloat(x['lon'])), opts);

    if (L.latLng(x['lat'], x['lon']).equals(default_depot)) {
        m.bindPopup(x['name'] + "<br> <b>Current Depot Location</b> ");

        $('#depot_location').val(x['lat']+','+x['lon']);
    }
    else
        m.bindPopup(x['name'] + "<br> <a href='javascript:void(0)' onclick='_use_depot("+x["int_id"]+")'>Use this as Depot Location</a>");

    // If already in layer, remove first
    m._leaflet_id = x['id'];

    if (layer_hubs.hasLayer( m )) {
        layer_hubs.removeLayer( m );
    }

    layer_hubs.addLayer( m );

    return m;
}

// Handle Rebalance Form Submission

// Rebalance Stations
function _route( v ) {
        if (v == "next") {
            id = parseInt( $('.leg_active').data('id') );

            $('#leg_' + (id+1)).click();
        }
        else if (v == "depot") {

            from = $('.leg_active').data('loc');
            from = {'lat':from.split(',')[0], 'lon':from.split(',')[1]}

            to = $('input[name=depot_location]')[0].value;
            to = to.replace("(", "").replace(")","");
            to = {'lat':to.split(',')[0], 'lon':to.split(',')[1]};

            // Add start/end flags to layer
        	directions.clearLayers();
        	directions.addLayer( L.marker(L.latLng(from['lat'], from['lon']), {icon: StartIcon}) );
            directions.addLayer( L.marker(L.latLng(to['lat'], to['lon']), {icon: EndIcon}) );
            directions.addTo(lmap);

            // plot itinerary polyline, and add turn-by-turn to dropdown
        	get_itinerary(from, to, "CAR,WALK");
        }
}

function do_route( leg ) {

	// Hide all other directions
	$('.leg_directions').css('display', "none");
	$('.leg').removeClass('leg_active');

	$(leg).addClass('leg_active');

	id = $(leg).data('id');
	loc = $(leg).data('loc');

	// get the last station or the depot and clean up the lat,lng for start
	if (last_station == null) last_station = $('input[name=depot_location]')[0].value;
	last_station = last_station.replace("(", "").replace(")","");

	// use current station for destination
    current_station = loc;

	from = {'lat':last_station.split(',')[0], 'lon':last_station.split(',')[1]}
	to = {'lat':current_station.split(',')[0], 'lon':current_station.split(',')[1]};

	// Add start/end flags to layer
	directions.clearLayers();
	directions.addLayer( L.marker(L.latLng(from['lat'], from['lon']), {icon: StartIcon}) );
    directions.addLayer( L.marker(L.latLng(to['lat'], to['lon']), {icon: EndIcon}) );
    directions.addTo(lmap);

    // plot itinerary polyline, and add turn-by-turn to dropdown
	get_itinerary(from, to, "CAR,WALK");

    last_station = current_station;
}

function _form(frm) {

    $('#form').hide();
    $('.show_form').show();
    $('.spinner').show();
    $('.tour_buttons').show();

	// Post the form to the Algorithm/Wrapper
    $.ajax({
      url: config['rebalance_uri'],
      type: 'POST',
      data: new FormData( frm ),
      contentType: false,
      processData: false,
      dataType: 'json'
    }).success(function(d){

        // hide spinner
        $('.spinner').hide();
        $('.step_2').hide();
        lmap.removeLayer( layer_hubs );
        layer.clearLayers();
        directions.clearLayers();

        // render instructions
		var el = $(config['notes_div']);
        el.html("").show();

        step_id = 1;

        for (veh in d) {
            el.append( "<h3>" + veh + "</h3>" );

            for (x in d[veh]) {
                line = d[veh][x];

                line['id'] = step_id;

			    // Render mustache template with station data
                el.append( ich.note_templ(line) );

                // Add marker to map
    			m = L.marker(L.latLng(line['Latitude'], line['Longitude']), {icon: SmallIcon});
    			m.bindPopup("Station #" + line['id']);
    			layer.addLayer(m);

                step_id++;
            }
        }

        layer.addTo(lmap);

        // Handle clicks on all legs of tour
        $('.leg').on('click', function() {
            do_route( $(this) );
        });

        // Click the first leg to begin the route
		do_route( $('#leg_1') );

		// XXX route summary info : total pickups, dropoffs, stations visited

	});

	return false;
}

// App Initialization
$(document).ready(function() {

    sobi_hubs_json = {"hub_1104": {"docks_available": 4, "name": "Lot 18 South", "lon": -82.40267515182495, "bikes_available": 0, "lat": 28.060264665300465, "int_id": "1104", "id": "hub_1104"}, "hub_1112": {"docks_available": 0, "name": "Lot 43", "lon": -82.41648852825165, "bikes_available": 0, "lat": 28.06795926070394, "int_id": "1112", "id": "hub_1112"}, "hub_1270": {"docks_available": 83, "name": "Shop", "lon": -82.4076198041439, "bikes_available": 0, "lat": 28.060548696070995, "int_id": "1270", "id": "hub_1270"}, "hub_1218": {"docks_available": 10, "name": "MSC North", "lon": -82.41346836090088, "bikes_available": 0, "lat": 28.064297828721415, "int_id": "1218", "id": "hub_1218"}, "hub_1219": {"docks_available": 15, "name": "MSC South", "lon": -82.41391763091087, "bikes_available": 0, "lat": 28.063202570065037, "int_id": "1219", "id": "hub_1219"}, "hub_1216": {"docks_available": 15, "name": "Juniper-Poplar-Magnolia", "lon": -82.41858132183552, "bikes_available": 0, "lat": 28.05947588505838, "int_id": "1216", "id": "hub_1216"}, "hub_1217": {"docks_available": 11, "name": "REC", "lon": -82.40777134895325, "bikes_available": 2, "lat": 28.059885956844763, "int_id": "1217", "id": "hub_1217"}, "hub_1220": {"docks_available": 25, "name": "Cooper", "lon": -82.41085857152939, "bikes_available": 0, "lat": 28.05980903164109, "int_id": "1220", "id": "hub_1220"}, "hub_1226": {"docks_available": 3, "name": "Lot 18 north", "lon": -82.40264296531677, "bikes_available": 1, "lat": 28.06553330970077, "int_id": "1226", "id": "hub_1226"}, "hub_1097": {"docks_available": 1, "name": "Patel Center", "lon": -82.40845799446106, "bikes_available": 0, "lat": 28.05550112500214, "int_id": "1097", "id": "hub_1097"}};

    for (k in sobi_hubs_json) {
            x = sobi_hubs_json[k];

            x['pos'] = L.latLng(x['lat'], x['lon']);

            hubs[x['int_id']] = x;
    }

    // Leaflet tile config
    baselayer = {
            name: 'MapQuest OSM',
            tileUrl: 'http://{s}.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png',
            subdomains : ['otile1','otile2','otile3','otile4'],
            attribution : 'Data, imagery and map information provided by <a href="http://open.mapquest.com" target="_blank">MapQuest</a>, <a href="http://www.openstreetmap.org/" target="_blank">OpenStreetMap</a> and contributors.'
    };

    var layerProps = { };
    if(baselayer.attribution) layerProps['attribution'] = baselayer.attribution;
    if(baselayer.subdomains) layerProps['subdomains'] = baselayer.subdomains;

    var mapProps = {
            layers  : [ new L.TileLayer(baselayer.tileUrl, layerProps) ],
            center : (new L.LatLng(28.061643, -82.413189)),
            zoom : (15),
            zoomControl : true
     };

     lmap = new L.Map('map', mapProps);

    // Load Mustache Templates
    ich.grabTemplates();

    // Add marker for depot
    layer_hubs.addTo(lmap);
    for (x in hubs) {
        add_hub_marker(hubs[x]);
    }

    // Enable click handlers
    $('#toggle_current_location').on('click', function() {
            handle_location_gps_tracking( {'button': $('#toggle_current_location'),
            'input_elem': $('#depot_location') } );
    });

    $('#rebal_submit').click(function() {
	       _form(document.forms['form']);
    });

});

// Find actual turn-by-turn itinerary from one station to another from OTP API
function get_itinerary(from, to, mode) {
    url = "http://%otp_url%?fromPlace=%from_lat%%2C%from_lon%&toPlace=%to_lat%%2C%to_lon%&mode=%mode%&maxWalkDistance=1609.34&wheelchair=false&arriveBy=true&showIntermediateStops=true";

	url = url.replace("%otp_url%", config['otp_url']);
    url = url.replace("%from_lat%", from['lat']);
    url = url.replace("%from_lon%", from['lon']);
    url = url.replace("%to_lat%", to['lat']);
    url = url.replace("%to_lon%", to['lon']);

	if (mode == undefined) mode = "CAR,WALK";
    url = url.replace("%mode%", mode);

	ret = $.ajax({
	   url: url,
	   dataType: 'json',
	   success: function(d) {
           if (d['plan'] == undefined && mode != "WALK") {
               get_itinerary( from, to, "WALK");
           }
           else if (d['plan'] == undefined) {
               console.log(d); // XXX log
           }
           else drawItin(d['plan']['itineraries'], colors['car'], directions);
       }
	});
}

function drawItin(itin, legColor, drawLayer) {

	// default map layer
	if (drawLayer == undefined) drawLayer = layer;

	// Iterate each leg in result
	for (t=0; t < itin.length; t++) {
		row = itin[t];

        for (i=0; i < row.legs.length; i++) {
        	var leg = row.legs[i];

            switch (leg.mode) {
            case "WALK":
                legColor = colors['walk'];
                break;
            case "CAR":
                legColor = colors['car'];
                break;
            case "BICYCLE":
                legColor = colors['bike'];
                break;
            }

	        // draw the polyline
        	var polyline = new L.Polyline(otp.util.Geo.decodePolyline(leg.legGeometry.points), {color: legColor});
            var weight = 8;
    	    drawLayer.addLayer(polyline);

            polyline.leg = leg;
    	    polyline.bindPopup("("+leg.routeShortName+") "+leg.routeLongName);

		    // XXX add more leg details using mustache template to collapsed div

		}

	}

	drawLayer.addTo(lmap);
}

</script>

</body>
</html>
